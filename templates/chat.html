<!-- templates/messages.html -->
<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages ‚Ä¢ Instagram</title>
    <style>
        body {
            background: #fafafa;
            font-family: Arial, sans-serif;
            display: flex;
        }

        /* Asosiy sidebar */
        .main-sidebar {
            width: 60px;
            background: white;
            border-right: 1px solid #dbdbdb;
            height: 100vh;
            overflow-y: auto;
            position: fixed;
            z-index: 100;
        }
        .main-sidebar a {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            text-decoration: none;
            color: #262626;
            font-size: 24px;
            transition: background 0.2s;
        }
        .main-sidebar a:hover {
            background: #f2f2f2;
        }
        .main-sidebar svg {
            width: 24px;
            height: 24px;
        }

        /* Chap panel */
        .sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #dbdbdb;
            height: 100vh;
            overflow-y: auto;
            margin-left: 60px;
            z-index: 99;
        }
        .sidebar-header {
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .username {
            font-weight: bold;
            font-size: 16px;
        }
        .compose-btn {
            width: 24px;
            height: 24px;
            background: #e1306c;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .search-box {
            margin: 0 20px 20px;
            padding: 10px;
            border: 1px solid #dbdbdb;
            border-radius: 4px;
            background: #f2f2f2;
        }
        .section-title {
            padding: 0 20px 10px;
            font-weight: bold;
            color: #777;
        }
        .user-item {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .user-item:hover {
            background: #f2f2f2;
        }
        .active {
            background: #f2f2f2;
        }
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
            background: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #777;
            font-weight: bold;
        }
        .user-info {
            flex-grow: 1;
        }
        .user-name {
            font-weight: bold;
            font-size: 14px;
        }
        .last-message {
            font-size: 12px;
            color: #777;
        }

        /* O'ng panel */
        .main {
            flex-grow: 1;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            padding: 15px 20px;
            border-bottom: 1px solid #dbdbdb;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            background: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #777;
            font-weight: bold;
        }
        .chat-user {
            flex-grow: 1;
        }
        .chat-username {
            font-weight: bold;
            font-size: 16px;
        }
        .chat-status {
            font-size: 12px;
            color: #777;
        }
        .chat-actions {
            display: flex;
            gap: 10px;
        }
        .chat-action {
            font-size: 20px;
            cursor: pointer;
        }

        /* Chat box */
        .chat-box {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            background: white;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }
        .message {
            max-width: 70%;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            word-wrap: break-word;
        }
        .sent {
            background: #e1f5fe;
            align-self: flex-end;
            text-align: right;
        }
        .received {
            background: #f1f1f1;
            align-self: flex-start;
        }
        .message-time {
            font-size: 10px;
            color: #777;
            margin-top: 4px;
            text-align: right;
        }

        /* Input bar */
        .input-bar {
            padding: 15px 20px;
            border-top: 1px solid #dbdbdb;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .input-box {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #dbdbdb;
            border-radius: 4px;
            outline: none;
        }
        .send-btn {
            padding: 10px 20px;
            background: #e1306c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .send-btn:hover {
            background: #c1275c;
        }
    </style>
</head>
<body>

<!-- Asosiy sidebar -->
<div class="main-sidebar">
    <a href="/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 20H5v-4h4v4zm6-12h-4V4h4v4zm4 16h-4v-4h4v4zM15 12h-4v-4h4v4zm-6 8H5v-4h4v4zm6 0h-4v-4h4v4z"/></svg></a>
    <a href="search/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 12.91 3 9 3S2 5.91 2 9.5c0 1.61.59 3.09 1.58 4.23L8 18v4h8v-4l4.42-4.42zM9 17c-1.33 0-2.5-1.17-2.5-2.5S7.67 12 9 12s2.5 1.17 2.5 2.5S10.33 17 9 17z"/></svg></a>
    <a href="#"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-7 12l-5-5 1.41-1.41L12 12.17l7-7L20.41 7 12 15.41z"/></svg></a>
    <a href="#"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.5 11.5l-1.45 1.32z"/></svg></a>
    <a href="/post/create"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg></a>
    <a href="/{{ request.user.username }}/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></a>
    <a href="#" style="margin-top: 20px;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></a>
</div>

<!-- Chap panel -->
<div class="sidebar">
    <div class="sidebar-header">
        <span class="username">{{ request.user.username }}</span>
        <div class="compose-btn">+</div>
    </div>

    <div class="search-box">
        <input type="text" placeholder="Search" style="width: 100%; border: none; background: transparent;">
    </div>

    <div class="section-title">Messages</div>

    {% for user in recent_users %}
    <div class="user-item {% if user.username == selected_user.username %}active{% endif %}" data-username="{{ user.username }}">
        <!-- Avatar -->
        {% if user.image %}
            <img src="{{ user.image.url }}" alt="{{ user.username }}" class="avatar">
        {% else %}
            <div class="avatar">{{ user.username|first|upper }}</div>
        {% endif %}

        <!-- Info -->
        <div class="user-info">
            <div class="user-name">{{ user.username }}</div>
            <div class="last-message">You: {{ user.last_message|truncatechars:10 }} ¬∑ {{ user.last_activity|timesince }} ago</div>
        </div>
    </div>
    {% empty %}
    <p style="padding: 20px; color: #777; text-align: center;">No messages yet.</p>
    {% endfor %}
</div>

<!-- O'ng panel -->
<div class="main">
    <!-- Chat header -->
    <div class="chat-header">
        <!-- User avatar -->
        {% if selected_user.image %}
            <img src="{{ selected_user.image.url }}" alt="{{ selected_user.username }}" class="chat-avatar">
        {% else %}
            <div class="chat-avatar">{{ selected_user.username|first|upper }}</div>
        {% endif %}

        <!-- User info -->
        <div class="chat-user">
            <div class="chat-username">{{ selected_user.username }}</div>
            <div class="chat-status">Active {{ selected_user.last_activity|timesince }} ago</div>
        </div>

        <!-- Actions -->
        <div class="chat-actions">
            <div class="chat-action">üìû</div>
            <div class="chat-action">üé•</div>
            <div class="chat-action">‚ÑπÔ∏è</div>
        </div>
    </div>

    <!-- Chat box -->
    <div class="chat-box">
        {% for msg in messages %}
        <div class="message {% if msg.sender == request.user %}sent{% else %}received{% endif %}">
            {{ msg.text }}
            <div class="message-time">{{ msg.timestamp|date:"H:i" }}</div>
        </div>
        {% empty %}
        <p style="color: #777; text-align: center;">Start a conversation!</p>
        {% endfor %}
    </div>

    <!-- Input bar -->
        <form class="flex items-center gap-3 mt-6 mb-2">
            {% csrf_token %}
            <div>üòä</div>
            <input type="text" name="text" class="input-box" placeholder="Message..." required>
            <button type="submit" class="send-btn">Send</button>
        </form>
</div>

<script>
// Tanlangan foydalanuvchi
const selectedUser = "{{ selected_user.username }}";

// User item click
document.querySelectorAll('.user-item').forEach(item => {
    item.addEventListener('click', function() {
        const username = this.dataset.username;
        window.location.href = `/messages/${username}/`;
    });
});

// Avtomatik yangilash
setInterval(() => {
    fetch(window.location.href)
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newChatBox = doc.querySelector('.chat-box');
            if (newChatBox) {
                document.querySelector('.chat-box').innerHTML = newChatBox.innerHTML;
                document.querySelector('.chat-box').scrollTop = document.querySelector('.chat-box').scrollHeight;
            }
        });
}, 3000);
</script>

</body>
</html>